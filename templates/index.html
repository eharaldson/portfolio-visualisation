<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #35393b;
            margin: 0;
            padding: 20px;
            color: #f5f5dc;
        }
        
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        
        .left-section {
            flex: 2;
            background-color: #2a2d2f;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        
        .right-section {
            flex: 1;
            background-color: #2a2d2f;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            overflow-y: auto;
        }
        
        h1 {
            text-align: center;
            color: #f5f5dc;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        h2 {
            color: #f5f5dc;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .form-container {
            background-color: #3a3e40;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #f5f5dc;
        }
        
        input[type="text"], input[type="date"], input[type="number"], select {
            padding: 12px;
            border: 2px solid #555;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            background-color: #2a2d2f;
            color: #f5f5dc;
        }
        
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .multi-select {
            position: relative;
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #2a2d2f;
            border: 2px solid #555;
            border-top: none;
            border-radius: 0 0 8px 8px;
            display: none;
            z-index: 1000;
        }
        
        .multi-select-dropdown.show {
            display: block;
        }
        
        .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #f5f5dc;
        }
        
        .multi-select-option:hover {
            background-color: #3a3e40;
        }
        
        .multi-select-option.selected {
            background-color: #4a5052;
        }
        
        .multi-select-option input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex: 1;
        }
        
        button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background-color: #2E86AB;
        }
        
        button.secondary:hover {
            background-color: #236a8a;
        }

        button.order-btn {
            background-color: #F18F01;
        }

        button.order-btn:hover {
            background-color: #d47701;
        }

        button.edit-btn {
            background-color: #A23B72;
        }

        button.edit-btn:hover {
            background-color: #8a2f5e;
        }

        button.delete-btn {
            background-color: #C73E1D;
        }

        button.delete-btn:hover {
            background-color: #a52e16;
        }
        
        #plotDiv {
            background-color: #2a2d2f;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            min-height: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #b0b0b0;
        }
        
        .error {
            background-color: #5a2a2a;
            color: #ff9999;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #8a4a4a;
        }

        .success {
            background-color: #2a5a2a;
            color: #99ff99;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #4a8a4a;
        }
        
        .info-text {
            color: #b0b0b0;
            font-size: 14px;
            margin-top: 10px;
            font-style: italic;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: #2a2d2f;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close {
            color: #b0b0b0;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: #f5f5dc;
        }

        .allocation-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #3a3e40;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #allocationChart {
            background-color: #2a2d2f;
            border-radius: 10px;
            padding: 15px;
        }

        .order-management {
            margin-bottom: 20px;
        }

        .order-section {
            margin-bottom: 25px;
        }

        .file-upload-area {
            border: 2px dashed #555;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #4CAF50;
            background-color: #3a3e40;
        }

        .file-upload-area.dragover {
            border-color: #4CAF50;
            background-color: #3a3e40;
        }

        .upload-placeholder {
            color: #b0b0b0;
            font-size: 16px;
            padding: 20px;
        }

        .required-columns {
            background-color: #3a3e40;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }

        .required-columns code {
            color: #4CAF50;
            background: none;
        }

        .upload-step {
            min-height: 300px;
        }

        .warning-box {
            background-color: #5a4a2a;
            color: #ffcc99;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #8a6a2a;
            text-align: center;
        }

        .csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
            background-color: #3a3e40;
            border-radius: 8px;
            overflow: hidden;
        }

        .csv-preview-table th,
        .csv-preview-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #555;
        }

        .csv-preview-table th {
            background-color: #4a5052;
            font-weight: bold;
        }

        .csv-preview-table tr:last-child td {
            border-bottom: none;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #b0b0b0;
            font-size: 14px;
        }

        .logout-btn {
            background-color: #C73E1D;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .logout-btn:hover {
            background-color: #a52e16;
            transform: translateY(-1px);
        }
        
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .left-section, .right-section {
                flex: 1;
            }
            
            .modal-content {
                width: 98%;
                max-width: none;
                margin: 1% auto;
                padding: 20px 15px;
                max-height: 95vh;
            }

            .csv-preview-table {
                font-size: 10px;
            }

            .csv-preview-table th,
            .csv-preview-table td {
                padding: 4px 6px;
                min-width: 60px;
            }

            .header-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-section">
            <div class="header-section">
                <h1>📈 Big Beautiful Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, {{ current_user.email }}</span>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </div>
            
            <div class="form-container">
                <form id="stockForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_date">Start Date:</label>
                            <input type="date" id="start_date" name="start_date">
                            <div class="info-text">Leave empty for 5 years ago</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="end_date">End Date:</label>
                            <input type="date" id="end_date" name="end_date">
                            <div class="info-text">Leave empty for today</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ticker">Search Stock Ticker:</label>
                            <input type="text" id="ticker" name="ticker" placeholder="e.g., AAPL">
                            <div class="info-text">Add any ticker to compare</div>
                        </div>
                        
                        <div class="form-group multi-select">
                            <label for="portfolio_tickers">Portfolio Stocks:</label>
                            <input type="text" id="portfolio_tickers" placeholder="Select stocks..." readonly onclick="toggleDropdown('tickers')">
                            <div id="tickers-dropdown" class="multi-select-dropdown"></div>
                        </div>
                        
                        <div class="form-group multi-select">
                            <label for="sectors">Sectors:</label>
                            <input type="text" id="sectors" placeholder="Select sectors..." readonly onclick="toggleDropdown('sectors')">
                            <div id="sectors-dropdown" class="multi-select-dropdown"></div>
                        </div>
                        
                        <div class="form-group" style="min-width: 120px;">
                            <label>&nbsp;</label>
                            <div style="display: flex; align-items: center; padding: 12px; height: 48px; box-sizing: border-box;">
                                <input type="checkbox" id="plotPerformance" style="margin-right: 8px; transform: scale(1.2);">
                                <label for="plotPerformance" style="margin-bottom: 0; font-size: 14px; cursor: pointer;">Plot your performance</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit">Generate Plot</button>
                        <button type="button" class="secondary" onclick="plotPortfolio()">Plot Portfolio</button>
                        <button type="button" class="secondary" onclick="clearPlot()">Clear Plot</button>
                    </div>
                </form>
            </div>
            
            <div id="plotDiv">
                <div class="loading">
                    Select options above and click "Generate Plot" to visualize the data.
                </div>
            </div>
        </div>
        
        <div class="right-section">
            <h2>📊 Portfolio Allocation</h2>
            
            <div class="allocation-section">
                <div id="allocationChart" style="height: 400px; margin-bottom: 30px;">
                    <div class="loading">Loading portfolio allocation...</div>
                </div>
                <button class="secondary" onclick="refreshAllocation()" style="width: 100%; margin-bottom: 30px;">
                    🔄 Refresh Allocation
                </button>
            </div>
            
            <h2>📊 Order Management</h2>
            
            <div class="order-management">
                <div class="order-section">
                    <div class="button-group">
                        <button class="order-btn" onclick="downloadOrders()">📥 Download Orders</button>
                        <button class="order-btn" onclick="openAddOrderModal()">➕ Add Order</button>
                        <button class="order-btn" onclick="openUploadModal()">📤 Upload CSV</button>
                    </div>
                </div>
                
                <div class="order-section">
                    <div class="button-group">
                        <button class="edit-btn" onclick="editLastOrder()">✏️ Edit Last</button>
                        <button class="delete-btn" onclick="deleteLastOrder()">🗑️ Delete Last</button>
                    </div>
                </div>
            </div>

            <div id="orderStatus"></div>
        </div>
    </div>

    <!-- Order Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2 id="modalTitle">Add New Order</h2>
            
            <form id="orderForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderDate">Date:</label>
                        <input type="date" id="orderDate" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderType">Order Type:</label>
                        <select id="orderType" name="order_type" required>
                            <option value="">Select type</option>
                            <option value="buy">Buy</option>
                            <option value="sell">Sell</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderTicker">Ticker:</label>
                        <input type="text" id="orderTicker" name="ticker" required placeholder="e.g., AAPL">
                    </div>
                    
                    <div class="form-group">
                        <label for="orderCompany">Company:</label>
                        <input type="text" id="orderCompany" name="company" required placeholder="Company name">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="orderShares">Number of Shares:</label>
                        <input type="number" id="orderShares" name="num_shares" step="0.001" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderPrice">Price per Share:</label>
                        <input type="number" id="orderPrice" name="price" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="foreignCommission">Foreign Commission:</label>
                        <input type="number" id="foreignCommission" name="foreign_commission" step="0.01" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="domesticCommission">Domestic Commission:</label>
                        <input type="number" id="domesticCommission" name="domestic_commission" step="0.01" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="splitRatio">Split Ratio (optional):</label>
                        <input type="text" id="splitRatio" name="split_ratio" placeholder="e.g., 2:1">
                    </div>
                    
                    <div class="form-group">
                        <label for="mergerOldTicker">Merger Old Ticker (optional):</label>
                        <input type="text" id="mergerOldTicker" name="merger_old_ticker" placeholder="Old ticker symbol">
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" id="submitOrderBtn">Add Order</button>
                    <button type="button" class="secondary" onclick="closeOrderModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload CSV Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUploadModal()">&times;</span>
            <h2 id="uploadModalTitle">Upload Orders CSV</h2>
            
            <div id="uploadStep1" class="upload-step">
                <p>Upload a CSV file with your stock orders. The file must contain these columns:</p>
                <div class="required-columns">
                    <code>date, num_shares, company, ticker, price, foreign_commission, domestic_commission, order_type, split_ratio, merger_old_ticker</code>
                </div>
                
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="csvFile" accept=".csv" style="display: none;">
                    <div class="upload-placeholder" onclick="document.getElementById('csvFile').click()">
                        📁 Click to select CSV file or drag and drop
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" onclick="console.log('Upload button clicked'); uploadCSV()" id="uploadBtn" disabled>Validate & Preview</button>
                    <button type="button" class="secondary" onclick="closeUploadModal()">Cancel</button>
                </div>
            </div>
            
            <div id="uploadStep2" class="upload-step" style="display: none;">
                <h3>CSV Validation Results</h3>
                <div id="validationResults"></div>
                <div id="previewSection" style="display: none;">
                    <h4>Preview (first 3 rows):</h4>
                    <div class="csv-preview-container">
                        <div id="csvPreview"></div>
                    </div>
                </div>
                
                <div class="warning-box">
                    ⚠️ <strong>Warning:</strong> This will replace your existing orders file. Your current orders will be backed up automatically.
                </div>
                
                <div class="button-group">
                    <button type="button" onclick="confirmUpload()" id="confirmBtn" class="delete-btn">Replace Orders File</button>
                    <button type="button" class="secondary" onclick="backToUpload()">Back</button>
                    <button type="button" class="secondary" onclick="closeUploadModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedTickers = [];
        let selectedSectors = [];
        let portfolioData = {};
        let sectorData = {};
        let isEditMode = false;
        
        // Initialize the page
        async function initialize() {
            // Set default dates
            document.getElementById('end_date').valueAsDate = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);
            document.getElementById('start_date').valueAsDate = fiveYearsAgo;
            
            // Set default order date to today
            document.getElementById('orderDate').valueAsDate = new Date();
            
            // Load portfolio data
            await loadPortfolioData();
            
            // Load portfolio allocation chart
            await loadPortfolioAllocation();
        }
        
        // Load portfolio tickers and sectors
        async function loadPortfolioData() {
            try {
                const response = await fetch('/get_portfolio_data');
                const data = await response.json();
                
                portfolioData = data;
                
                // Populate tickers dropdown
                const tickersDropdown = document.getElementById('tickers-dropdown');
                tickersDropdown.innerHTML = '';
                data.tickers.forEach(ticker => {
                    const option = document.createElement('div');
                    option.className = 'multi-select-option';
                    option.innerHTML = `<input type="checkbox" value="${ticker}" onchange="updateSelection('tickers', '${ticker}')">${ticker}`;
                    tickersDropdown.appendChild(option);
                });
                
                // Populate sectors dropdown
                const sectorsDropdown = document.getElementById('sectors-dropdown');
                sectorsDropdown.innerHTML = '';
                data.sectors.forEach(sector => {
                    const option = document.createElement('div');
                    option.className = 'multi-select-option';
                    option.innerHTML = `<input type="checkbox" value="${sector}" onchange="updateSelection('sectors', '${sector}')">${sector}`;
                    sectorsDropdown.appendChild(option);
                });
                
                // Store sector data for later use
                sectorData = data.sector_mapping;
                
            } catch (error) {
                console.error('Error loading portfolio data:', error);
            }
        }
        
        // Load portfolio allocation data and create pie chart
        async function loadPortfolioAllocation() {
            try {
                const response = await fetch('/get_portfolio_allocation');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('allocationChart').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                const allocation = data.allocation;
                
                // Check if allocation data is empty
                if (!allocation || Object.keys(allocation).length === 0) {
                    document.getElementById('allocationChart').innerHTML = '<div class="loading">No portfolio data available</div>';
                    return;
                }
                
                // Prepare data for pie chart
                const labels = Object.keys(allocation);
                const values = Object.values(allocation).map(item => item[0]); // Get percentage values
                const usdValues = Object.values(allocation).map(item => item[1]); // Get USD values
                const colors = [
                    '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd',
                    '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf',
                    '#2E86AB', '#A23B72', '#F18F01', '#C73E1D', '#4CAF50'
                ];
                
                // Create pie chart
                const pieData = [{
                    values: values,
                    labels: labels,
                    type: 'pie',
                    marker: {
                        colors: colors.slice(0, labels.length),
                        line: {
                            color: '#2a2d2f',
                            width: 2
                        }
                    },
                    textinfo: 'percent',
                    textposition: 'inside',
                    textfont: {
                        color: '#ffffff',
                        size: 11,
                        family: 'Arial, sans-serif'
                    },
                    customdata: usdValues, // Pass USD values as custom data
                    hovertemplate: '<b>%{label}</b><br>' +
                                  'Allocation: %{percent}<br>' +
                                  'Value: $%{customdata:,.0f}<br>' +
                                  '<extra></extra>',
                    hoverlabel: {
                        bgcolor: '#2a2d2f',
                        bordercolor: '#4CAF50',
                        font: {
                            color: '#f5f5dc',
                            size: 13
                        }
                    }
                }];
                
                const pieLayout = {
                    title: {
                        text: 'Current Portfolio Allocation',
                        font: {
                            color: '#f5f5dc',
                            size: 16
                        }
                    },
                    paper_bgcolor: '#2a2d2f',
                    plot_bgcolor: '#2a2d2f',
                    font: {
                        color: '#f5f5dc'
                    },
                    margin: {
                        l: 10,
                        r: 10,
                        t: 50,
                        b: 10
                    },
                    showlegend: false
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: false
                };
                
                Plotly.newPlot('allocationChart', pieData, pieLayout, config);
                
            } catch (error) {
                console.error('Error loading portfolio allocation:', error);
                document.getElementById('allocationChart').innerHTML = `<div class="error">Error loading allocation: ${error.message}</div>`;
            }
        }

        // Refresh portfolio allocation
        async function refreshAllocation() {
            document.getElementById('allocationChart').innerHTML = '<div class="loading">Refreshing portfolio allocation...</div>';
            await loadPortfolioAllocation();
        }
        
        // Toggle dropdown visibility
        function toggleDropdown(type) {
            const dropdown = document.getElementById(`${type}-dropdown`);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            const otherType = type === 'tickers' ? 'sectors' : 'tickers';
            document.getElementById(`${otherType}-dropdown`).classList.remove('show');
        }
        
        // Update selection
        function updateSelection(type, value) {
            const checkbox = event.target;
            const option = checkbox.parentElement;
            
            if (type === 'tickers') {
                if (checkbox.checked) {
                    selectedTickers.push(value);
                    option.classList.add('selected');
                } else {
                    selectedTickers = selectedTickers.filter(t => t !== value);
                    option.classList.remove('selected');
                }
                document.getElementById('portfolio_tickers').value = selectedTickers.join(', ');
            } else {
                if (checkbox.checked) {
                    selectedSectors.push(value);
                    option.classList.add('selected');
                } else {
                    selectedSectors = selectedSectors.filter(s => s !== value);
                    option.classList.remove('selected');
                }
                document.getElementById('sectors').value = selectedSectors.join(', ');
            }
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
        
        // Plot portfolio performance
        async function plotPortfolio() {
            // Create a hidden input to indicate we want to include portfolio
            let portfolioInput = document.getElementById('include_portfolio');
            if (!portfolioInput) {
                portfolioInput = document.createElement('input');
                portfolioInput.type = 'hidden';
                portfolioInput.id = 'include_portfolio';
                portfolioInput.name = 'plot_portfolio';
                document.getElementById('stockForm').appendChild(portfolioInput);
            }
            portfolioInput.value = 'true';
            
            // Submit the form
            document.getElementById('stockForm').dispatchEvent(new Event('submit'));
        }
        
        // Clear plot
        function clearPlot() {
            document.getElementById('plotDiv').innerHTML = '<div class="loading">Select options above and click "Generate Plot" to visualize the data.</div>';
            document.getElementById('ticker').value = '';
            selectedTickers = [];
            selectedSectors = [];
            document.getElementById('portfolio_tickers').value = '';
            document.getElementById('sectors').value = '';
            document.getElementById('plotPerformance').checked = false;
            document.querySelectorAll('.multi-select-option').forEach(option => {
                option.classList.remove('selected');
                const checkbox = option.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
            
            // Also clear the portfolio flag
            const portfolioInput = document.getElementById('include_portfolio');
            if (portfolioInput) {
                portfolioInput.value = 'false';
            }
        }

        // Order management functions
        async function downloadOrders() {
            try {
                const response = await fetch('/download_orders');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Orders.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus('Orders downloaded successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showStatus(`Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error downloading orders: ${error.message}`, 'error');
            }
        }

        function openAddOrderModal() {
            isEditMode = false;
            document.getElementById('modalTitle').textContent = 'Add New Order';
            document.getElementById('submitOrderBtn').textContent = 'Add Order';
            clearOrderForm();
            document.getElementById('orderModal').style.display = 'block';
        }

        async function editLastOrder() {
            try {
                const response = await fetch('/get_last_order');
                if (response.ok) {
                    const data = await response.json();
                    const order = data.order;
                    
                    isEditMode = true;
                    document.getElementById('modalTitle').textContent = 'Edit Last Order';
                    document.getElementById('submitOrderBtn').textContent = 'Update Order';
                    
                    // Populate form with order data
                    document.getElementById('orderDate').value = order.date;
                    document.getElementById('orderType').value = order.order_type;
                    document.getElementById('orderTicker').value = order.ticker;
                    document.getElementById('orderCompany').value = order.company;
                    document.getElementById('orderShares').value = order.num_shares;
                    document.getElementById('orderPrice').value = order.price;
                    document.getElementById('foreignCommission').value = order.foreign_commission || 0;
                    document.getElementById('domesticCommission').value = order.domestic_commission || 0;
                    document.getElementById('splitRatio').value = order.split_ratio || '';
                    document.getElementById('mergerOldTicker').value = order.merger_old_ticker || '';
                    
                    document.getElementById('orderModal').style.display = 'block';
                } else {
                    const errorData = await response.json();
                    showStatus(`Error: ${errorData.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error loading last order: ${error.message}`, 'error');
            }
        }

        async function deleteLastOrder() {
            if (!confirm('Are you sure you want to delete the last order? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/delete_last_order', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(data.message, 'success');
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error deleting order: ${error.message}`, 'error');
            }
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            clearOrderForm();
        }

        function clearOrderForm() {
            document.getElementById('orderForm').reset();
            document.getElementById('orderDate').valueAsDate = new Date();
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('orderStatus');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // CSV Upload Functions
        function openUploadModal() {
            document.getElementById('uploadModal').style.display = 'block';
            document.getElementById('uploadStep1').style.display = 'block';
            document.getElementById('uploadStep2').style.display = 'none';
            resetUploadForm();
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            resetUploadForm();
        }

        function resetUploadForm() {
            document.getElementById('csvFile').value = '';
            document.getElementById('uploadBtn').disabled = true;
            document.querySelector('.upload-placeholder').textContent = '📁 Click to select CSV file or drag and drop';
            document.getElementById('validationResults').innerHTML = '';
            document.getElementById('csvPreview').innerHTML = '';
        }

        function backToUpload() {
            document.getElementById('uploadStep1').style.display = 'block';
            document.getElementById('uploadStep2').style.display = 'none';
        }

        // File selection handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.querySelector('.upload-placeholder').textContent = `📄 ${file.name}`;
                document.getElementById('uploadBtn').disabled = false;
            } else {
                document.querySelector('.upload-placeholder').textContent = '📁 Click to select CSV file or drag and drop';
                document.getElementById('uploadBtn').disabled = true;
            }
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('fileUploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.toLowerCase().endsWith('.csv')) {
                    document.getElementById('csvFile').files = files;
                    document.querySelector('.upload-placeholder').textContent = `📄 ${file.name}`;
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    showStatus('Please select a CSV file', 'error');
                }
            }
        });

        async function uploadCSV() {
            console.log('uploadCSV function called');
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                console.log('No file selected');
                showStatus('Please select a file', 'error');
                return;
            }

            console.log('File selected:', file.name, 'Size:', file.size);

            const formData = new FormData();
            formData.append('file', file);

            try {
                console.log('Starting upload...');
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').textContent = 'Validating...';

                console.log('Sending request to /upload_orders');
                const response = await fetch('/upload_orders', {
                    method: 'POST',
                    body: formData,
                    // Don't set Content-Type header, let browser set it for FormData
                });

                console.log('Response received:', response.status, response.statusText);
                console.log('Response headers:', response.headers);

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    console.log('Upload successful, showing results');
                    // Show validation results
                    document.getElementById('validationResults').innerHTML = `
                        <div class="success">
                            ✅ ${data.message}<br>
                            📊 Found ${data.row_count} orders in the file
                        </div>
                    `;

                    // Show preview
                    if (data.preview && data.preview.length > 0) {
                        console.log('Creating preview table');
                        const previewHtml = createPreviewTable(data.preview);
                        document.getElementById('csvPreview').innerHTML = previewHtml;
                        document.getElementById('previewSection').style.display = 'block';
                    }

                    // Move to step 2
                    console.log('Moving to step 2');
                    document.getElementById('uploadStep1').style.display = 'none';
                    document.getElementById('uploadStep2').style.display = 'block';
                } else {
                    console.log('Upload failed, showing error');
                    document.getElementById('validationResults').innerHTML = `
                        <div class="error">❌ ${data.error}</div>
                    `;
                    document.getElementById('uploadStep1').style.display = 'none';
                    document.getElementById('uploadStep2').style.display = 'block';
                    document.getElementById('previewSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error in uploadCSV:', error);
                showStatus(`Error uploading file: ${error.message}`, 'error');
            } finally {
                console.log('Resetting button state');
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'Validate & Preview';
            }
        }

        function createPreviewTable(data) {
            let html = '<table class="csv-preview-table"><thead><tr>';
            
            // Create headers
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Create rows
            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    let value = row[header];
                    // Handle various null/undefined/NaN values
                    if (value === null || value === undefined || value === 'NaN' || 
                        (typeof value === 'number' && isNaN(value))) {
                        value = '';
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        async function confirmUpload() {
            try {
                document.getElementById('confirmBtn').disabled = true;
                document.getElementById('confirmBtn').textContent = 'Uploading...';

                const response = await fetch('/confirm_upload', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showStatus(data.message, 'success');
                    closeUploadModal();
                    // Refresh allocation chart if it exists
                    if (typeof refreshAllocation === 'function') {
                        refreshAllocation();
                    }
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error confirming upload: ${error.message}`, 'error');
            } finally {
                document.getElementById('confirmBtn').disabled = false;
                document.getElementById('confirmBtn').textContent = 'Replace Orders File';
            }
        }
        
        // Handle form submission for plotting
        document.getElementById('stockForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            document.getElementById('plotDiv').innerHTML = '<div class="loading">Loading data...</div>';
            
            const formData = new FormData(this);
            
            // Add selected tickers
            if (selectedTickers.length > 0) {
                formData.append('selected_tickers', selectedTickers.join(','));

                // Add the plot performance checkbox state
                const plotPerformance = document.getElementById('plotPerformance').checked;
                formData.append('plot_performance', plotPerformance);
            }
            
            // Add selected sectors
            if (selectedSectors.length > 0) {
                formData.append('selected_sectors', selectedSectors.join(','));
                
                // Add the plot performance checkbox state
                const plotPerformance = document.getElementById('plotPerformance').checked;
                formData.append('plot_performance', plotPerformance);
            }
            
            // Check if we should include portfolio (from hidden input)
            const portfolioInput = document.getElementById('include_portfolio');
            if (!portfolioInput || portfolioInput.value !== 'true') {
                formData.append('plot_portfolio', 'false');
            }
            
            try {
                const response = await fetch('/plot', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('plotDiv').innerHTML = `<div class="error">Error: ${data.error}</div>`;
                } else {
                    const plotData = JSON.parse(data.plot);
                    Plotly.newPlot('plotDiv', plotData.data, plotData.layout, {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                        displaylogo: false
                    });
                }
                
                // Reset portfolio flag after plotting
                if (portfolioInput && portfolioInput.value === 'true') {
                    portfolioInput.value = 'false';
                }
            } catch (error) {
                document.getElementById('plotDiv').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });

        // Handle order form submission
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const endpoint = isEditMode ? '/update_last_order' : '/add_order';
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(data.message, 'success');
                    closeOrderModal();
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error submitting order: ${error.message}`, 'error');
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeOrderModal();
            }
        });
        
        // Initialize on page load
        initialize();
    </script>
</body>
</html>